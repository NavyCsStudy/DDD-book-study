# 11. CQRS

## 11.1 단일 모델의 단점
- 식별자를 이용해서 애그리거트를 참조하는 방식 단점
  - 즉시 로딩 방식 같은 JPA 관련 쿼리 최적화 기능 사용이 불가
  - 한 번의 select 쿼리로 필요한 데이터를 읽어올 수 없음
- 단일 도메인 모델 구조에서 애그리거트에서 데이터를 가져와 출력하는 기능은 구현이 복잡

- 해결 방법 : 상태 변경을 위한 모델과 조회를 위한 모델을 분리

## 11.2 CQRS
- 시스템이 제공하는 기능 : 상태 변경, 상태 정보 조회
- 상태 변경 기능은 주로 한 애그리거트의 상태를 변경 ex) 주문 취소 기능
- 조회 기능은 두 개 이상의 애그리거트가 필요 ex) 주문 상세 조회
- 상태 변경 기능과 상태 조회 기능의 범위가 정확하게 일치하지 않아 단일 모델로 구현할 경우 불필요하게 복잡해짐
- 해결 방법 : CQRS(Command Query Responsibility Segregation)
  - 상태를 변경하는 `명령`을 위한 모델과 상태를 제공하는 `조회`를 위한 모델을 분리하는 패턴
  - CQRS를 사용하면 도메인 모델이 복잡해지는 것을 막을 수 있음
    - 명령 모델은 객체를 기반으로 한 도메인 모델을 이용하여 구현
    - 조회 모델은 필요한 정보만을 담고 있는 데이터 타입을 이용하여 구현
  - CQRS를 사용하면 각 모델에 맞는 구현 기술을 선택할 수 있음
    - 명령 모델에는 JPA 사용
    - 조회 모델은 DB 테이블에서 SQL로 조회할 때 좋은 마이바티스 사용
  - 명령 모델과 조회 모델이 서로 다른 데이터 저장소를 사용할 수도 있음
    - 명령 모델은 트랜잭션을 지원하는 RDBMS / 조회 모델은 조회 성능이 좋은 메모리 기반 NoSQL
    - 데이터 동기화는 이벤트를 활용해서 처리 -> 명령 모델에서 상태를 변경하면 이벤트를 발생하고 조회 모델에서 변경 내역을 반영
      - 즉시 반영해야할 경우: 동기 이벤트와 글로벌 트랜잭션을 사용하여 동기화
      - 지연이 발생해도 되는 경우 : 비동기로 데이터를 전송

### 웹과 CQRS
- 일반적인 웹 서비스는 상태 변경 요청보다 조회 요청이 더 많음
- 조회 성능을 높이기 위한 기법 : 쿼리 최적화, 메모리에 조회 데이터 캐싱, 조회 전용 저장소 분리 -> CQRS 효과
- 조회 속도를 높이기 위해 별도 처리를 하고 있다면, 명시적으로 명령 모델과 조회 모델을 구분하는 것을 추천
  - 조회 기능 때문에 명령 모델이 복잡해지는 것을 막을 수 있고, 명령 모델과 독립적으로 조회 기능을 최적화 할 수 있음

### CQRS 장단점
- 장점
  - 조회 성능을 위한 코드가 명령 모델이 없으므로, 도메인 로직을 구현하는 데 집중할 수 있음
  - 명령 모델에 조회 관련 로직이 사라져 복잡도가 낮아짐
  - 명령 모델에 독립적으로 조회 성능을 높일 수 있음
    - 조회 단위로 캐시 기술을 적용
    - 조회에 특화된 쿼리를 쉽게 사용
    - 조회 전용 저장소를 사용하여 조회 처리량을 늘림
- 단점
  - 구현해야할 코드가 많아짐
  - 더 많은 구현 기술이 필요함
  - 데이터 동기화를 위한 메시징 시스템을 도입 필요성

- 결론 : 장단점 고려하여 CQRS 패턴을 도입할 지 결정해야함
  - 도메인이 충분히 복잡한지
  - 조회 트래픽이 크게 존재하는지